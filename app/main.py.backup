import sys
sys.path.append("/opt/ashal-bot")

import sys
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

#!/usr/bin/env python3
"""
ASHAL Bot - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø­Ø³Ù† Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ù†ØªØ§Ø¬
"""

import os
import requests
from flask import Flask, request, jsonify
from app.database import get_connection
import logging
logging.basicConfig(level=logging.DEBUG)

app = Flask(__name__)

# Ø§Ø³ØªØ®Ø¯Ø§Ù… WHATSAPP_TOKEN Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† .env
WHATSAPP_TOKEN = os.getenv('WHATSAPP_TOKEN', 'demo_token')
VERIFY_TOKEN = os.getenv('WHATSAPP_VERIFY_TOKEN', 'my_super_secret_token_123')
PHONE_NUMBER_ID = os.getenv('WHATSAPP_PHONE_NUMBER_ID', '766793799861074')

@app.route('/')
def home():
    return jsonify({
        'status': 'active',
        'project': 'ASHAL Bot',
        'version': '2.0',
        'whatsapp_ready': WHATSAPP_TOKEN != 'demo_token',
        'message': 'âœ… Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ¬Ø§Ù‡Ø² Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨!'
    })

@app.route('/health')
def health_check():
    """ÙØ­Øµ ØµØ­Ø© Ø§Ù„Ù†Ø¸Ø§Ù…"""
    try:
        conn = get_connection()
        conn.close()
        return jsonify({
            'database': 'âœ… Ù…ØªØµÙ„',
            'whatsapp_api': 'âœ… Ø¬Ø§Ù‡Ø²' if WHATSAPP_TOKEN != 'demo_token' else 'âš ï¸ ÙŠØ­ØªØ§Ø¬ ØªÙˆÙƒÙ†',
            'services': 'âœ… Ù†Ø´Ø·Ø©',
            'status': 'healthy'
        })
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/reminders/send-test')
def send_test_reminder():
    """Ø¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒÙŠØ± ØªØ¬Ø±ÙŠØ¨ÙŠ"""
    try:
        test_message = "ğŸ§ª Ù‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù…Ù† ASHAL Bot\nâœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø´ØºØ§Ù„ ÙˆØ¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ù†ØªØ§Ø¬!"
        result = send_whatsapp_message("+15551840522", test_message)
        return jsonify({'message': 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©', 'result': result})
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/send-message', methods=['POST'])
def send_direct_message():
    """Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ø£ÙŠ Ø±Ù‚Ù…"""
    try:
        data = request.json
        phone_number = data.get('phone', '')
        message_text = data.get('message', '')
        
        if not phone_number or not message_text:
            return jsonify({'error': 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… ÙˆØ§Ù„Ø±Ø³Ø§Ù„Ø©'}), 400
        
        result = send_whatsapp_message(phone_number, message_text)
        return jsonify({
            'status': 'success',
            'message': 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©',
            'result': result
        })
    except Exception as e:
        return jsonify({'error': str(e)}), 500

def send_whatsapp_message(phone_number, message):
    """Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨"""
    if WHATSAPP_TOKEN == 'demo_token':
        return {'status': 'demo', 'message': 'ÙˆØ¶Ø¹ Ø§Ù„ØªØ¬Ø±Ø¨Ø© - ØªØ­ØªØ§Ø¬ ØªÙˆÙƒÙ† Ø­Ù‚ÙŠÙ‚ÙŠ'}
    
    url = f"https://graph.facebook.com/v18.0/{PHONE_NUMBER_ID}/messages"
    headers = {'Authorization': f'Bearer {WHATSAPP_TOKEN}', 'Content-Type': 'application/json'}
    data = {"messaging_product": "whatsapp", "to": phone_number, "type": "text", "text": {"body": message}}
    
    try:
        response = requests.post(url, headers=headers, json=data)
        logging.info(f"ğŸ“¤ Ø±Ø³Ø§Ù„Ø© Ù…Ø±Ø³Ù„Ø©: {response.status_code}")
        return response.json()
    except Exception as e:
        logging.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: {e}")
        return {'error': str(e)}

if __name__ == '__main__':
    logging.info("ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ ASHAL Bot v2.0 Ø§Ù„Ù…Ø­Ø³Ù†...")
    app.run(host='0.0.0.0', port=5001, debug=False)
