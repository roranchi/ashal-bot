import requests
import os
import datetime
from supabase import create_client
from guardian.smart_project_guardian import SmartProjectGuardianPro

# Ø¥Ø¹Ø¯Ø§Ø¯ Supabase
supabase = create_client(os.getenv('SUPABASE_URL'), os.getenv('SUPABASE_KEY'))
guardian = SmartProjectGuardianPro(project_path='/opt/ashal-bot/', supabase=supabase)

# Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
ENDPOINTS = [
    'http://localhost:5000/ai-agent/health',
    'http://localhost:5000/ai-agent/report',
    'http://localhost:5000/analytics/sql/occupancy/1',
    'http://localhost:5000/analytics/sql/churn-risk/1'
]

def log_to_supabase(event_type, details, status="success"):
    try:
        supabase.table('ai_agent_logs').insert({
            'event_type': event_type,
            'details': details,
            'severity': 'high' if status == 'error' else 'info',
            'timestamp': datetime.datetime.utcnow().isoformat() + 'Z'
        }).execute()
    except Exception as e:
        print(f"âŒ Error logging to Supabase: {e}")

def run_health_check():
    print("ğŸš€ Running automated health check...")
    results = []

    for url in ENDPOINTS:
        try:
            r = requests.get(url, timeout=10)
            status = 'success' if r.status_code == 200 else 'error'
            results.append({
                'url': url,
                'status_code': r.status_code,
                'status': status,
                'response': r.text[:200]
            })
            log_to_supabase('endpoint_check', {'url': url, 'status': status, 'code': r.status_code})
        except Exception as e:
            log_to_supabase('endpoint_check', {'url': url, 'error': str(e)}, status='error')
            guardian.run_silent_monitoring()

    print("âœ… Health check complete.")
    return results


def auto_run_on_start():
    try:
        print("ğŸ©º Auto health check triggered on startup...")
        run_health_check()
    except Exception as e:
        print(f"âš ï¸ Auto health check failed: {e}")

# ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø©
auto_run_on_start()

if __name__ == "__main__":
    run_health_check()
